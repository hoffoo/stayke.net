<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
<head>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<title>~/code/stayke.net/src/go-spotify/main.go.html</title>
<meta name="Generator" content="Vim/7.4">
<meta name="plugin-version" content="vim7.4_v1">
<meta name="syntax" content="go">
<meta name="settings" content="dynamic_folds,no_pre,use_css,expand_tabs,prevent_copy=">
<meta name="colorscheme" content="ir_black">
<style type="text/css">
<!--
body { color: #cecece; background-color: black; font-family: monospace; }
* { font-size: 1em; }
.String { color: #A8FF60; }
.Number { color: #FF73FD; }
.FoldColumn { color: Cyan; background-color: Grey; padding-bottom: 1px; }
.Keyword { color: #96CBFE; }
.Conditional { color: #6699CC; }
.Statement { color: #6699CC; font-weight: bold; }
.Comment { color: #A8FF60; font-weight: bold; }
.Type { color: #FFFFB6; text-decoration: underline; }
.Special { color: #E18964; font-weight: bold; }
.FoldColumn { text-decoration: none; white-space: pre; }
.open-fold   .Folded      { display: none; }
.open-fold   .fulltext      { display: inline; }
.open-fold   .toggle-open   { display: none; }
.closed-fold .toggle-closed { display: inline; }

.closed-fold .fulltext      { display: none; }
.closed-fold .Folded      { display: inline; }
.closed-fold .toggle-open   { display: inline; }
.closed-fold .toggle-closed { display: none; }
-->
</style>

<script type='text/javascript'>
<!--

function toggleFold(objID)
{
  var fold;
  fold = document.getElementById(objID);
  if(fold.className == 'closed-fold')
  {
    fold.className = 'open-fold';
  }
  else if (fold.className == 'open-fold')
  {
    fold.className = 'closed-fold';
  }
}

-->
</script>
</head>
<body>
<div id='vimCodeElement'>
<span class="Statement">package</span>&nbsp;main<br>
<br>
<span class="Statement">import</span>&nbsp;(<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="String">&quot;flag&quot;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="String">&quot;fmt&quot;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;dbus&nbsp;<span class="String">&quot;github.com/hoffoo/go.dbus&quot;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="String">&quot;io&quot;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="String">&quot;net/http&quot;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="String">&quot;os&quot;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="String">&quot;os/signal&quot;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="String">&quot;os/user&quot;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="String">&quot;strings&quot;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="String">&quot;syscall&quot;</span><br>
)<br>
<br>
<span class="Keyword">var</span>&nbsp;sdbus *dbus.Object<br>
<span class="Keyword">var</span>&nbsp;ART_CACHE&nbsp;<span class="Type">string</span><br>
<br>
<span class="Keyword">const</span>&nbsp;ART_BASE =&nbsp;<span class="String">&quot;/.spotify-art/&quot;</span><br>
<br>
<span class="Keyword">func</span>&nbsp;main() {<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="Keyword">var</span>&nbsp;img&nbsp;<span class="Type">bool</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;flag.BoolVar(&amp;img,&nbsp;<span class="String">&quot;i&quot;</span>,&nbsp;<span class="Keyword">false</span>,&nbsp;<span class="String">&quot;get album art image&quot;</span>)<br>
&nbsp;&nbsp;&nbsp;&nbsp;flag.Parse()<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;action := flag.Arg(<span class="Number">0</span>)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;sdbus = connDbus()<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="Keyword">var</span>&nbsp;song *dbus.Variant<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="Conditional">switch</span>&nbsp;action {<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="Statement">case</span>&nbsp;<span class="String">&quot;&quot;</span>:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;song = Metadata()<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;pstatus := Status()<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="Comment">// buggy spotify dbus only sends a single artist</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;songData := song.Value().(<span class="Type">map</span>[<span class="Type">string</span>]dbus.Variant)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;artist := songData[<span class="String">&quot;xesam:artist&quot;</span>].Value().([]<span class="Type">string</span>)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;title := songData[<span class="String">&quot;xesam:title&quot;</span>]<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;rating :=&nbsp;<span class="Type">int</span>(songData[<span class="String">&quot;xesam:autoRating&quot;</span>].Value().(<span class="Type">float64</span>) *&nbsp;<span class="Number">100</span>)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="Conditional">if</span>&nbsp;songStatus := pstatus.Value().(<span class="Type">string</span>); songStatus ==&nbsp;<span class="String">&quot;Paused&quot;</span>&nbsp;{<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fmt.Printf(<span class="String">&quot;(paused) %s %s (paused)&quot;</span>, artist[<span class="Number">0</span>], title)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;<span class="Conditional">else</span>&nbsp;{<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fmt.Printf(<span class="String">&quot;%s %s (%d)&quot;</span>, artist[<span class="Number">0</span>], title, rating)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="Statement">case</span>&nbsp;<span class="String">&quot;url&quot;</span>:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;song := Metadata()<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;songData := song.Value().(<span class="Type">map</span>[<span class="Type">string</span>]dbus.Variant)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;url := songData[<span class="String">&quot;xesam:url&quot;</span>].Value().(<span class="Type">string</span>)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fmt.Printf(<span class="String">&quot;<a href="http://open.spotify.com/track/%s">http://open.spotify.com/track/%s</a></span><span class="Special">\n</span><span class="String">&quot;</span>, strings.Split(url,&nbsp;<span class="String">&quot;:&quot;</span>)[<span class="Number">2</span>])<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="Statement">case</span>&nbsp;<span class="String">&quot;next&quot;</span>:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;MethodCall(<span class="String">&quot;Next&quot;</span>)<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="Statement">case</span>&nbsp;<span class="String">&quot;prev&quot;</span>:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;MethodCall(<span class="String">&quot;Previous&quot;</span>)<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="Statement">case</span>&nbsp;<span class="String">&quot;pause&quot;</span>:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;MethodCall(<span class="String">&quot;PlayPause&quot;</span>)<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="Statement">default</span>:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;OpenUri(action)<br>
&nbsp;&nbsp;&nbsp;&nbsp;}<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="Comment">// if we supplied the image arg update the album art</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="Conditional">if</span>&nbsp;img {<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;u, err := user.Current()<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="Conditional">if</span>&nbsp;err !=&nbsp;<span class="Keyword">nil</span>&nbsp;{<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="Keyword">panic</span>(err)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ART_CACHE = u.HomeDir + ART_BASE<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="Conditional">if</span>&nbsp;song ==&nbsp;<span class="Keyword">nil</span>&nbsp;{<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;song = Metadata()<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;songData := song.Value().(<span class="Type">map</span>[<span class="Type">string</span>]dbus.Variant)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;artUrl := songData[<span class="String">&quot;mpris:artUrl&quot;</span>].Value().(<span class="Type">string</span>)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Art(artUrl)<br>
&nbsp;&nbsp;&nbsp;&nbsp;}<br>
}<br>
<br>
<span class="Keyword">func</span>&nbsp;connDbus() *dbus.Object {<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;conn, err := dbus.SessionBus()<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="Comment">// couldnt connect to session bus</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="Conditional">if</span>&nbsp;err !=&nbsp;<span class="Keyword">nil</span>&nbsp;{<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="Keyword">panic</span>(err)<br>
&nbsp;&nbsp;&nbsp;&nbsp;}<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="Statement">return</span>&nbsp;conn.Object(<span class="String">&quot;org.mpris.MediaPlayer2.spotify&quot;</span>,&nbsp;<span class="String">&quot;/org/mpris/MediaPlayer2&quot;</span>)<br>
}<br>
<br>
<span class="Keyword">func</span>&nbsp;MethodCall(method&nbsp;<span class="Type">string</span>) {<br>
&nbsp;&nbsp;&nbsp;&nbsp;sdbus.Call(method,&nbsp;<span class="Number">0</span>)<br>
}<br>
<br>
<span class="Keyword">func</span>&nbsp;OpenUri(uri&nbsp;<span class="Type">string</span>) {<br>
&nbsp;&nbsp;&nbsp;&nbsp;sdbus.Call(<span class="String">&quot;OpenUri&quot;</span>,&nbsp;<span class="Number">0</span>, uri)<br>
}<br>
<br>
<span class="Keyword">func</span>&nbsp;Metadata() *dbus.Variant {<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="Comment">// get song data, quit on err</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;song, err := sdbus.GetProperty(<span class="String">&quot;org.mpris.MediaPlayer2.Player.Metadata&quot;</span>)<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="Conditional">if</span>&nbsp;err !=&nbsp;<span class="Keyword">nil</span>&nbsp;{<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="Keyword">panic</span>(err)&nbsp;<span class="Comment">// most likely spotify not running</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;}<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="Statement">return</span>&nbsp;&amp;song<br>
}<br>
<br>
<span class="Keyword">func</span>&nbsp;Status() *dbus.Variant {<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;pstatus, err := sdbus.GetProperty(<span class="String">&quot;org.mpris.MediaPlayer2.Player.PlaybackStatus&quot;</span>)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="Conditional">if</span>&nbsp;err !=&nbsp;<span class="Keyword">nil</span>&nbsp;{<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="Keyword">panic</span>(err)&nbsp;<span class="Comment">// most likely spotify not running</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;}<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="Statement">return</span>&nbsp;&amp;pstatus<br>
}<br>
<br>
<span class="Keyword">func</span>&nbsp;Art(url&nbsp;<span class="Type">string</span>) {<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;idx := strings.LastIndex(url,&nbsp;<span class="String">&quot;/&quot;</span>)<br>
&nbsp;&nbsp;&nbsp;&nbsp;filename := url[idx+<span class="Number">1</span>:]<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;outfile, err := os.OpenFile(ART_CACHE+filename, os.O_RDONLY,&nbsp;<span class="Number">0660</span>)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="Conditional">if</span>&nbsp;os.IsNotExist(err) {<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;sig :=&nbsp;<span class="Keyword">make</span>(<span class="Type">chan</span>&nbsp;os.Signal,&nbsp;<span class="Number">1</span>)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;signal.Notify(sig, syscall.SIGTERM, syscall.SIGQUIT)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="Statement">go</span>&nbsp;<span class="Type">func</span>() {<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;-sig<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;os.Remove(ART_CACHE + filename)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}()<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;resp, err := http.Get(<span class="String">&quot;<a href="http://d3rt1990lpmkn.cloudfront.net/unbranded/">http://d3rt1990lpmkn.cloudfront.net/unbranded/</a>&quot;</span>&nbsp;+ filename)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="Conditional">if</span>&nbsp;err !=&nbsp;<span class="Keyword">nil</span>&nbsp;{<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fmt.Fprintln(os.Stderr,&nbsp;<span class="String">&quot;couldnt download album art&quot;</span>)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="Statement">return</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;outfile, _ = os.Create(ART_CACHE + filename)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;_, ioerr := io.Copy(outfile, resp.Body)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;resp.Body.Close()<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="Conditional">if</span>&nbsp;ioerr !=&nbsp;<span class="Keyword">nil</span>&nbsp;{<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;outfile.Close()<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;os.Remove(ART_CACHE + filename)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fmt.Fprintln(os.Stderr,&nbsp;<span class="String">&quot;failed getting the album art file&quot;</span>)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="Statement">return</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;outfile.Close()<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="Keyword">close</span>(sig)<br>
&nbsp;&nbsp;&nbsp;&nbsp;}<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;os.Remove(ART_CACHE +&nbsp;<span class="String">&quot;cur&quot;</span>)<br>
&nbsp;&nbsp;&nbsp;&nbsp;os.Link(ART_CACHE+filename, ART_CACHE+<span class="String">&quot;cur&quot;</span>)<br>
}<br>
</div>
</body>
</html>
<!-- vim: set foldmethod=manual : -->
