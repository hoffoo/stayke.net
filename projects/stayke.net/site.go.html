<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
<head>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<title>~/code/stayke.net/src/stayke.net/site.go.html</title>
<meta name="Generator" content="Vim/7.4">
<meta name="plugin-version" content="vim7.4_v1">
<meta name="syntax" content="go">
<meta name="settings" content="dynamic_folds,no_pre,use_css,expand_tabs,prevent_copy=">
<meta name="colorscheme" content="ir_black">
<style type="text/css">
<!--
body { color: #cecece; background-color: black; font-family: monospace; }
* { font-size: 1em; }
.Type { color: #FFFFB6; text-decoration: underline; }
.Statement { color: #6699CC; font-weight: bold; }
.Number { color: #FF73FD; }
.Comment { color: #A8FF60; font-weight: bold; }
.Keyword { color: #96CBFE; }
.FoldColumn { color: Cyan; background-color: Grey; padding-bottom: 1px; }
.Conditional { color: #6699CC; }
.String { color: #A8FF60; }
.Special { color: #E18964; font-weight: bold; }
.Todo { color: #8f8f8f; }
.FoldColumn { text-decoration: none; white-space: pre; }
.open-fold   .Folded      { display: none; }
.open-fold   .fulltext      { display: inline; }
.open-fold   .toggle-open   { display: none; }
.closed-fold .toggle-closed { display: inline; }

.closed-fold .fulltext      { display: none; }
.closed-fold .Folded      { display: inline; }
.closed-fold .toggle-open   { display: inline; }
.closed-fold .toggle-closed { display: none; }
-->
</style>

<script type='text/javascript'>
<!--

function toggleFold(objID)
{
  var fold;
  fold = document.getElementById(objID);
  if(fold.className == 'closed-fold')
  {
    fold.className = 'open-fold';
  }
  else if (fold.className == 'open-fold')
  {
    fold.className = 'closed-fold';
  }
}

-->
</script>
</head>
<body>
<div id='vimCodeElement'>
<span class="Statement">package</span>&nbsp;homepage<br>
<br>
<span class="Statement">import</span>&nbsp;(<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="String">&quot;bytes&quot;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="String">&quot;errors&quot;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="String">&quot;fmt&quot;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="String">&quot;github.com/paulbellamy/mango&quot;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="String">&quot;net/http&quot;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="String">&quot;io/ioutil&quot;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="String">&quot;log&quot;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="String">&quot;os&quot;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="String">&quot;path/filepath&quot;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="String">&quot;strings&quot;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="String">&quot;time&quot;</span><br>
)<br>
<br>
<span class="Keyword">var</span>&nbsp;(<br>
&nbsp;&nbsp;&nbsp;&nbsp;html&nbsp;&nbsp;&nbsp;&nbsp; Pages<br>
&nbsp;&nbsp;&nbsp;&nbsp;projects Projects<br>
)<br>
<br>
<span class="Keyword">type</span>&nbsp;(<br>
&nbsp;&nbsp;&nbsp;&nbsp;Projects&nbsp;<span class="Type">map</span>[<span class="Type">string</span>][]<span class="Type">string</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;Pages&nbsp;&nbsp;&nbsp;&nbsp;<span class="Type">map</span>[<span class="Type">string</span>][]<span class="Type">byte</span><br>
)<br>
<br>
<span class="Keyword">var</span>&nbsp;startTime time.Time<br>
<span class="Keyword">var</span>&nbsp;expireTime time.Time<br>
<span class="Keyword">var</span>&nbsp;expirationHeaders mango.Headers<br>
<br>
<span class="Keyword">func</span>&nbsp;StartHTTP(addr&nbsp;<span class="Type">string</span>) {<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;expirationHeaders = mango.Headers{}<br>
&nbsp;&nbsp;&nbsp;&nbsp;MakeExpirationHeader()<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;html = Pages{}<br>
&nbsp;&nbsp;&nbsp;&nbsp;filepath.Walk(<span class="String">&quot;html&quot;</span>, html.Walker)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;projects = Projects{}<br>
&nbsp;&nbsp;&nbsp;&nbsp;filepath.Walk(<span class="String">&quot;projects&quot;</span>, projects.Walker)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;projects.MakeNav()<br>
&nbsp;&nbsp;&nbsp;&nbsp;html.MakeNav()<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;projects.CleanupFileLinks()<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;app := mango.Stack{}<br>
&nbsp;&nbsp;&nbsp;&nbsp;app.Address = addr<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;r :=&nbsp;<span class="Type">map</span>[<span class="Type">string</span>]mango.App{<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="String">&quot;^/project/.*&quot;</span>: app.Compile(Project),<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="String">&quot;^/code/.*&quot;</span>:&nbsp;&nbsp;&nbsp;&nbsp;app.Compile(ProjectCode),<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="String">&quot;^/.*&quot;</span>:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; app.Compile(Index),<br>
&nbsp;&nbsp;&nbsp;&nbsp;}<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;app.Middleware(mango.Routing(r))<br>
&nbsp;&nbsp;&nbsp;&nbsp;app.Run(FourOhFour)<br>
}<br>
<br>
<span class="Keyword">func</span>&nbsp;Index(e mango.Env) (mango.Status, mango.Headers, mango.Body) {<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="Conditional">if</span>&nbsp;time.Now().After(expireTime) {<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;MakeExpirationHeader()<br>
&nbsp;&nbsp;&nbsp;&nbsp;}<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="Comment">// urls with .html and without</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="Comment">// handle / and /index</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;f := e.Request().URL.Path<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="Conditional">if</span>&nbsp;f ==&nbsp;<span class="String">&quot;/&quot;</span>&nbsp;|| f ==&nbsp;<span class="String">&quot;/home&quot;</span>&nbsp;{<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;f =&nbsp;<span class="String">&quot;/index&quot;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;}<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="Conditional">if</span>&nbsp;strings.Index(f,&nbsp;<span class="String">&quot;.&quot;</span>) &gt; -<span class="Number">1</span>&nbsp;{<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;f =&nbsp;<span class="String">&quot;html&quot;</span>&nbsp;+ f<br>
&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;<span class="Conditional">else</span>&nbsp;{<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;f =&nbsp;<span class="String">&quot;html&quot;</span>&nbsp;+ f +&nbsp;<span class="String">&quot;.html&quot;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;}<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;page, have := html[f]<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="Conditional">if</span>&nbsp;!have {<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="Statement">return</span>&nbsp;FourOhFour(e)<br>
&nbsp;&nbsp;&nbsp;&nbsp;}<br>
<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;log.Printf(<span class="String">&quot;req for %s&quot;</span>, f)<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="Conditional">if</span>&nbsp;t, err := time.Parse(http.TimeFormat, e.Request().Header.Get(<span class="String">&quot;If-Modified-Since&quot;</span>)); err ==&nbsp;<span class="Keyword">nil</span>&nbsp;&amp;&amp; t.Add(time.Second).Before(startTime) {<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="Statement">return</span>&nbsp;<span class="Number">304</span>, expirationHeaders,&nbsp;<span class="String">&quot;&quot;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;}<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="Statement">return</span>&nbsp;<span class="Number">200</span>, expirationHeaders, mango.Body(page)<br>
}<br>
<br>
<span class="Keyword">func</span>&nbsp;Project(e mango.Env) (mango.Status, mango.Headers, mango.Body) {<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;path := strings.Split(e.Request().URL.Path,&nbsp;<span class="String">&quot;/&quot;</span>)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="Conditional">if</span>&nbsp;<span class="Keyword">len</span>(path) &lt;&nbsp;<span class="Number">3</span>&nbsp;{<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;log.Printf(<span class="String">&quot;invalid project request: %s&quot;</span>, path)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="Statement">return</span>&nbsp;FourOhFour(e)<br>
&nbsp;&nbsp;&nbsp;&nbsp;}<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="Keyword">var</span>&nbsp;p, f&nbsp;<span class="Type">string</span><br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="Comment">// accepts requests in the form project/file, project/, project</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="Comment">// if no file send README.md.html</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;p = path[<span class="Number">2</span>]<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="Conditional">if</span>&nbsp;<span class="Keyword">len</span>(path) ==&nbsp;<span class="Number">3</span>&nbsp;{<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;f =&nbsp;<span class="String">&quot;README.md.html&quot;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;<span class="Conditional">else</span>&nbsp;<span class="Conditional">if</span>&nbsp;f = path[<span class="Number">3</span>]; f ==&nbsp;<span class="String">&quot;&quot;</span>&nbsp;{<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;f =&nbsp;<span class="String">&quot;README.md.html&quot;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;}<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;projFiles, have := projects[p]<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="Conditional">if</span>&nbsp;!have {<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;log.Printf(<span class="String">&quot;req for invalid project: %s&quot;</span>, p)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="Statement">return</span>&nbsp;FourOhFour(e)<br>
&nbsp;&nbsp;&nbsp;&nbsp;}<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="Conditional">if</span>&nbsp;t, err := time.Parse(http.TimeFormat, e.Request().Header.Get(<span class="String">&quot;If-Modified-Since&quot;</span>)); err ==&nbsp;<span class="Keyword">nil</span>&nbsp;&amp;&amp; t.Add(time.Second).Before(startTime) {<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="Statement">return</span>&nbsp;<span class="Number">304</span>, expirationHeaders,&nbsp;<span class="String">&quot;&quot;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;}<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;iframeUrl := fmt.Sprintf(<span class="String">&quot;/code/%s/%s&quot;</span>, p, f)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;projectNav :=&nbsp;<span class="Keyword">make</span>([]<span class="Type">string</span>,&nbsp;<span class="Keyword">len</span>(projFiles))<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="Statement">for</span>&nbsp;i, pfile :=&nbsp;<span class="Statement">range</span>&nbsp;projFiles {<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;projectNav[i] = fmt.Sprintf(<span class="String">`&lt;a href=&quot;/project/%s/%s.html&quot;&gt;%s&lt;/a&gt;`</span>, p, pfile, pfile)<br>
&nbsp;&nbsp;&nbsp;&nbsp;}<br>
&nbsp;&nbsp;&nbsp;&nbsp;nav := strings.Join(projectNav,&nbsp;<span class="String">&quot;</span><span class="Special">\n</span><span class="String">&quot;</span>)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;codePage := html[<span class="String">&quot;html/codepage.html&quot;</span>]<br>
&nbsp;&nbsp;&nbsp;&nbsp;codePage = bytes.Replace(codePage, []<span class="Type">byte</span>(<span class="String">&quot;{{{url}}}&quot;</span>), []<span class="Type">byte</span>(iframeUrl),&nbsp;<span class="Number">1</span>)<br>
&nbsp;&nbsp;&nbsp;&nbsp;codePage = bytes.Replace(codePage, []<span class="Type">byte</span>(<span class="String">&quot;{{{filenav}}}&quot;</span>), []<span class="Type">byte</span>(nav),&nbsp;<span class="Number">1</span>)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;log.Printf(<span class="String">&quot;req for project file [%s]: %s&quot;</span>, p, f)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="Statement">return</span>&nbsp;<span class="Number">200</span>, expirationHeaders, mango.Body(codePage)<br>
}<br>
<br>
<span class="Keyword">func</span>&nbsp;ProjectCode(e mango.Env) (mango.Status, mango.Headers, mango.Body) {<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;pathSpl := strings.Split(e.Request().URL.Path,&nbsp;<span class="String">&quot;/&quot;</span>)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="Conditional">if</span>&nbsp;<span class="Keyword">len</span>(pathSpl) !=&nbsp;<span class="Number">4</span>&nbsp;{<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;log.Printf(<span class="String">&quot;no file for /code req: %s&quot;</span>, e.Request().URL.Path)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="Statement">return</span>&nbsp;FourOhFour(e)<br>
&nbsp;&nbsp;&nbsp;&nbsp;}<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;p := pathSpl[<span class="Number">2</span>]<br>
&nbsp;&nbsp;&nbsp;&nbsp;f := pathSpl[<span class="Number">3</span>]<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;_, have := projects[p]<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="Conditional">if</span>&nbsp;!have {<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;log.Printf(<span class="String">&quot;req for bad project: %s&quot;</span>, p)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="Statement">return</span>&nbsp;FourOhFour(e)<br>
&nbsp;&nbsp;&nbsp;&nbsp;}<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;file, err := ioutil.ReadFile(fmt.Sprintf(<span class="String">&quot;projects/%s/%s&quot;</span>, p, f))<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="Conditional">if</span>&nbsp;err !=&nbsp;<span class="Keyword">nil</span>&nbsp;{<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;log.Printf(<span class="String">&quot;couldnt load /code file [%s]: %s&quot;</span>, p, f)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;log.Print(err)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="Statement">return</span>&nbsp;FourOhFour(e)<br>
&nbsp;&nbsp;&nbsp;&nbsp;}<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;log.Printf(<span class="String">&quot;req for project code [%s]: %s&quot;</span>, p, f)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="Statement">return</span>&nbsp;<span class="Number">200</span>, expirationHeaders, mango.Body(file)<br>
}<br>
<br>
<span class="Keyword">func</span>&nbsp;FourOhFour(e mango.Env) (mango.Status, mango.Headers, mango.Body) {<br>
&nbsp;&nbsp;&nbsp;&nbsp;log.Printf(<span class="String">&quot;404 on: %s&quot;</span>, e.Request().URL.Path)<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="Statement">return</span>&nbsp;<span class="Number">404</span>, expirationHeaders, mango.Body(html[<span class="String">&quot;html/404.html&quot;</span>])<br>
}<br>
<br>
<span class="Keyword">func</span>&nbsp;(p Projects) Walker(path&nbsp;<span class="Type">string</span>, info os.FileInfo, err&nbsp;<span class="Type">error</span>)&nbsp;<span class="Type">error</span>&nbsp;{<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="Comment">//&nbsp;</span><span class="Todo">TODO</span><span class="Comment">&nbsp;no subdirs</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="Conditional">if</span>&nbsp;info.IsDir() {<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;level := strings.Count(path,&nbsp;<span class="String">&quot;/&quot;</span>)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="Conditional">if</span>&nbsp;level &lt;=&nbsp;<span class="Number">1</span>&nbsp;{<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;log.Printf(<span class="String">&quot;adding project: %s&quot;</span>, path)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="Statement">return</span>&nbsp;<span class="Keyword">nil</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;<span class="Conditional">else</span>&nbsp;{<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="Statement">return</span>&nbsp;filepath.SkipDir<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
&nbsp;&nbsp;&nbsp;&nbsp;}<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="Comment">// skip the first dir (projects)</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="Comment">// set second dir as the key (project name)</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="Comment">// set the rest as the filepath</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;spl := strings.SplitN(path,&nbsp;<span class="String">&quot;/&quot;</span>,&nbsp;<span class="Number">3</span>)<br>
&nbsp;&nbsp;&nbsp;&nbsp;p[spl[<span class="Number">1</span>]] =&nbsp;<span class="Keyword">append</span>(p[spl[<span class="Number">1</span>]], spl[<span class="Number">2</span>])<br>
&nbsp;&nbsp;&nbsp;&nbsp;log.Printf(<span class="String">&quot;added [%s] %s&quot;</span>, spl[<span class="Number">1</span>], path)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="Statement">return</span>&nbsp;<span class="Keyword">nil</span><br>
}<br>
<br>
<span class="Keyword">func</span>&nbsp;(p Projects) MakeNav() {<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="Keyword">var</span>&nbsp;result []<span class="Type">string</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="Statement">for</span>&nbsp;project, _ :=&nbsp;<span class="Statement">range</span>&nbsp;p {<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;result =&nbsp;<span class="Keyword">append</span>(result, fmt.Sprintf(<span class="String">`&lt;a href=&quot;%s&quot;&gt;%s&lt;/a&gt;`</span>,&nbsp;<span class="String">&quot;/project/&quot;</span>+project, project))<br>
&nbsp;&nbsp;&nbsp;&nbsp;}<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;html.Mustache(<span class="String">&quot;html/project.html&quot;</span>,&nbsp;<span class="String">&quot;{{{projectnav}}}&quot;</span>, strings.Join(result,&nbsp;<span class="String">&quot;</span><span class="Special">\n</span><span class="String">&quot;</span>))<br>
&nbsp;&nbsp;&nbsp;&nbsp;html.Mustache(<span class="String">&quot;html/codepage.html&quot;</span>,&nbsp;<span class="String">&quot;{{{projectnav}}}&quot;</span>, strings.Join(result,&nbsp;<span class="String">&quot;</span><span class="Special">\n</span><span class="String">&quot;</span>))<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;log.Printf(<span class="String">&quot;finished project nav&quot;</span>)<br>
}<br>
<br>
<span class="Comment">// fix the file links and turn into links</span><br>
<span class="Keyword">func</span>&nbsp;(p Projects) CleanupFileLinks() {<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="Statement">for</span>&nbsp;pr, fAr :=&nbsp;<span class="Statement">range</span>&nbsp;p {<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="Statement">for</span>&nbsp;i, f :=&nbsp;<span class="Statement">range</span>&nbsp;fAr {<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;p[pr][i] = strings.Replace(f,&nbsp;<span class="String">&quot;.html&quot;</span>,&nbsp;<span class="String">&quot;&quot;</span>,&nbsp;<span class="Number">1</span>)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
&nbsp;&nbsp;&nbsp;&nbsp;}<br>
}<br>
<br>
<span class="Keyword">func</span>&nbsp;(ps Pages) Walker(path&nbsp;<span class="Type">string</span>, info os.FileInfo, err&nbsp;<span class="Type">error</span>)&nbsp;<span class="Type">error</span>&nbsp;{<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="Comment">// lame way to check if this is the root that was passed</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="Conditional">if</span>&nbsp;info.IsDir() &amp;&amp; strings.Index(path,&nbsp;<span class="String">&quot;/&quot;</span>) &gt; -<span class="Number">1</span>&nbsp;{<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="Statement">return</span>&nbsp;filepath.SkipDir<br>
&nbsp;&nbsp;&nbsp;&nbsp;}<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;fileb, err := ioutil.ReadFile(path)<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="Conditional">if</span>&nbsp;err !=&nbsp;<span class="Keyword">nil</span>&nbsp;{<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;log.Print(err)<br>
&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;<span class="Conditional">else</span>&nbsp;{<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ps[path] = fileb<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;log.Print(<span class="String">&quot;cached: &quot;</span>&nbsp;+ path)<br>
&nbsp;&nbsp;&nbsp;&nbsp;}<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="Statement">return</span>&nbsp;<span class="Keyword">nil</span><br>
}<br>
<br>
<span class="Comment">// replace out {{{}} for special pages</span><br>
<span class="Keyword">func</span>&nbsp;(ps Pages) Mustache(file, pattern, newdata&nbsp;<span class="Type">string</span>)&nbsp;<span class="Type">error</span>&nbsp;{<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;page, have := ps[file]<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="Conditional">if</span>&nbsp;!have {<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;log.Printf(<span class="String">&quot;unable to mustache %s: no such file&quot;</span>, file)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="Statement">return</span>&nbsp;errors.New(<span class="String">&quot;unable to mustache: no such file&quot;</span>)<br>
&nbsp;&nbsp;&nbsp;&nbsp;}<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;newpage := bytes.Replace(page, []<span class="Type">byte</span>(pattern), []<span class="Type">byte</span>(newdata),&nbsp;<span class="Number">1</span>)<br>
&nbsp;&nbsp;&nbsp;&nbsp;ps[file] = newpage<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="Conditional">if</span>&nbsp;bytes.Equal(page, newpage) {<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;log.Printf(<span class="String">&quot;didnt replace %s in %s&quot;</span>, pattern, file)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="Statement">return</span>&nbsp;errors.New(<span class="String">&quot;mustache didnt replace &quot;</span>&nbsp;+ pattern +&nbsp;<span class="String">&quot; in &quot;</span>&nbsp;+ file)<br>
&nbsp;&nbsp;&nbsp;&nbsp;}<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="Statement">return</span>&nbsp;<span class="Keyword">nil</span><br>
}<br>
<br>
<span class="Keyword">func</span>&nbsp;(ps Pages) MakeNav() {<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;navPages := []<span class="Type">string</span>{<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="String">&quot;home&quot;</span>,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="String">&quot;about&quot;</span>,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="String">&quot;project&quot;</span>,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="String">&quot;resume&quot;</span>,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="String">&quot;contact&quot;</span>,<br>
&nbsp;&nbsp;&nbsp;&nbsp;}<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="Statement">for</span>&nbsp;i, l :=&nbsp;<span class="Statement">range</span>&nbsp;navPages {<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;navPages[i] = fmt.Sprintf(<span class="String">`&lt;a href=&quot;/%s&quot;&gt;%s&lt;/a&gt;`</span>, l, l)<br>
&nbsp;&nbsp;&nbsp;&nbsp;}<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;nav :=&nbsp;<span class="String">&quot;&lt;div id=</span><span class="Special">\&quot;</span><span class="String">nav</span><span class="Special">\&quot;</span><span class="String">&gt;</span><span class="Special">\n</span><span class="String">&quot;</span>&nbsp;+ strings.Join(navPages,&nbsp;<span class="String">&quot;</span><span class="Special">\n</span><span class="String">&quot;</span>) +&nbsp;<span class="String">&quot;&lt;/div&gt;&quot;</span><br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="Comment">//&nbsp;</span><span class="Todo">TODO</span><span class="Comment">&nbsp;check err here in case replace fails</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;ps.Mustache(<span class="String">&quot;html/index.html&quot;</span>,&nbsp;<span class="String">&quot;{{{nav}}}&quot;</span>, nav)<br>
&nbsp;&nbsp;&nbsp;&nbsp;ps.Mustache(<span class="String">&quot;html/about.html&quot;</span>,&nbsp;<span class="String">&quot;{{{nav}}}&quot;</span>, nav)<br>
&nbsp;&nbsp;&nbsp;&nbsp;ps.Mustache(<span class="String">&quot;html/project.html&quot;</span>,&nbsp;<span class="String">&quot;{{{nav}}}&quot;</span>, nav)<br>
&nbsp;&nbsp;&nbsp;&nbsp;ps.Mustache(<span class="String">&quot;html/contact.html&quot;</span>,&nbsp;<span class="String">&quot;{{{nav}}}&quot;</span>, nav)<br>
}<br>
<br>
<span class="Keyword">func</span>&nbsp;MakeExpirationHeader() {<br>
&nbsp;&nbsp;&nbsp;&nbsp;startTime = time.Now()<br>
&nbsp;&nbsp;&nbsp;&nbsp;expireTime = startTime.Add(<span class="Number">24</span>*time.Hour)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;expirationHeaders.Add(<span class="String">&quot;Last-Modified&quot;</span>, startTime.Format(http.TimeFormat))<br>
&nbsp;&nbsp;&nbsp;&nbsp;expirationHeaders.Add(<span class="String">&quot;Expires&quot;</span>, expireTime.Format(http.TimeFormat))<br>
}<br>
</div>
</body>
</html>
<!-- vim: set foldmethod=manual : -->
