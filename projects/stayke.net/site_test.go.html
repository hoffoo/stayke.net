<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
<head>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<title>~/code/stayke.net/src/stayke.net/site_test.go.html</title>
<meta name="Generator" content="Vim/7.4">
<meta name="plugin-version" content="vim7.4_v1">
<meta name="syntax" content="none">
<meta name="settings" content="dynamic_folds,no_pre,use_css,expand_tabs,prevent_copy=">
<meta name="colorscheme" content="none">
<style type="text/css">
<!--
body { color: #000000; background-color: #ffffff; font-family: monospace; }
* { font-size: 1em; }
.FoldColumn { color: #c00000; background-color: #c0c0c0; padding-bottom: 1px; }
.FoldColumn { text-decoration: none; white-space: pre; }
.open-fold   .Folded      { display: none; }
.open-fold   .fulltext      { display: inline; }
.open-fold   .toggle-open   { display: none; }
.closed-fold .toggle-closed { display: inline; }

.closed-fold .fulltext      { display: none; }
.closed-fold .Folded      { display: inline; }
.closed-fold .toggle-open   { display: inline; }
.closed-fold .toggle-closed { display: none; }
-->
</style>

<script type='text/javascript'>
<!--

function toggleFold(objID)
{
  var fold;
  fold = document.getElementById(objID);
  if(fold.className == 'closed-fold')
  {
    fold.className = 'open-fold';
  }
  else if (fold.className == 'open-fold')
  {
    fold.className = 'closed-fold';
  }
}

-->
</script>
</head>
<body>
<div id='vimCodeElement'>
package homepage<br>
<br>
import (<br>
&nbsp;&nbsp;&nbsp;&nbsp;&quot;bytes&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&quot;fmt&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&quot;log&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&quot;net/http&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&quot;os&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&quot;path/filepath&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&quot;strings&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&quot;sync&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&quot;testing&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&quot;time&quot;<br>
)<br>
<br>
const content = `404.html<br>
about.html<br>
bg.png<br>
robots.txt<br>
code.css<br>
codepage.html<br>
contact.html<br>
index.html<br>
main.css<br>
project.html`<br>
<br>
func TestWebApp(t *testing.T) {<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;setup(true)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;pageUris := strings.Split(content, &quot;\n&quot;)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;c := make(chan bool)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;for _, uri := range pageUris {<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;u := uri<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;go func() {<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;var failure bool<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;resp, err := http.Get(&quot;<a href="http://localhost:8999/">http://localhost:8999/</a>&quot; + u)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if err != nil {<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;t.Log(err)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if resp.StatusCode != 200 {<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;t.Log(resp.Request.URL.Path + &quot; failed&quot;)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;t.Fail()<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;failure = true<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;c &lt;- failure<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}()<br>
&nbsp;&nbsp;&nbsp;&nbsp;}<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;respc := 0<br>
&nbsp;&nbsp;&nbsp;&nbsp;for {<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;-c<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;respc++<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if respc == len(pageUris) {<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;break<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
&nbsp;&nbsp;&nbsp;&nbsp;}<br>
}<br>
<br>
// test that we are sending back stuff that can be cached<br>
func TestConditionalGet(t *testing.T) {<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;setup(true)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;client := &amp;http.Client{}<br>
&nbsp;&nbsp;&nbsp;&nbsp;req, err := http.NewRequest(&quot;GET&quot;, &quot;<a href="http://localhost:8999/bg.png">http://localhost:8999/bg.png</a>&quot;, nil)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;if err != nil {<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;t.Fatal(err)<br>
&nbsp;&nbsp;&nbsp;&nbsp;}<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;// req.Headers.Add()<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;// make the request to bg.png<br>
&nbsp;&nbsp;&nbsp;&nbsp;resp, err := client.Do(req)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;if err != nil {<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;t.Fatal(err)<br>
&nbsp;&nbsp;&nbsp;&nbsp;}<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;defer resp.Body.Close()<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;if resp.StatusCode != 200 {<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;t.Fatal(&quot;didnt return 200 on img req&quot;)<br>
&nbsp;&nbsp;&nbsp;&nbsp;}<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;if resp.Header.Get(&quot;Last-Modified&quot;) == &quot;&quot; || resp.Header.Get(&quot;Expires&quot;) == &quot;&quot; {<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;t.Fatal(&quot;didnt send back cache control headers&quot;)<br>
&nbsp;&nbsp;&nbsp;&nbsp;}<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;req, err = http.NewRequest(&quot;GET&quot;, &quot;<a href="http://localhost:8999/bg.png">http://localhost:8999/bg.png</a>&quot;, nil)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;mod := time.Now().Format(http.TimeFormat)<br>
&nbsp;&nbsp;&nbsp;&nbsp;req.Header.Add(&quot;If-Modified-Since&quot;, mod)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;resp, err = client.Do(req)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;if err != nil {<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;t.Fatal(err)<br>
&nbsp;&nbsp;&nbsp;&nbsp;}<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;if resp.StatusCode != 304 || resp.Header.Get(&quot;Last-Modified&quot;) == &quot;&quot; || resp.Header.Get(&quot;Expires&quot;) == &quot;&quot; {<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;t.Fatal(&quot;didnt send back cache control headers or status&quot;)<br>
&nbsp;&nbsp;&nbsp;&nbsp;}<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;defer resp.Body.Close()<br>
}<br>
<br>
func TestProjectWebAppReq(t *testing.T) {<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;setup(true)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;p := Projects{}<br>
&nbsp;&nbsp;&nbsp;&nbsp;filepath.Walk(&quot;projects&quot;, p.Walker)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;reqC := 0<br>
&nbsp;&nbsp;&nbsp;&nbsp;c := make(chan bool)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;for proj, files := range p {<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;proj := proj<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;files := files<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;reqC += len(files)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//reqC += len(files) + 1<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;resp, err := http.Get(fmt.Sprintf(&quot;<a href="http://localhost:8999/project/%s">http://localhost:8999/project/%s</a>&quot;, proj))<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// check all files and req to project /<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if err != nil || resp.StatusCode != 200 {<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;t.Log(&quot;error opening / for project: &quot; + proj)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;c &lt;- true<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;go func() {<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;for _, f := range files {<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;resp, err := http.Get(fmt.Sprintf(&quot;<a href="http://localhost:8999/project/%s/%s">http://localhost:8999/project/%s/%s</a>&quot;, proj, f))<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if err != nil || resp.StatusCode != 200 {<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;t.Log(fmt.Sprintf(&quot;projects %d: /project/%s/%s&quot;, resp.StatusCode, proj, f))<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;t.Fail()<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;c &lt;- true<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;} else {<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;c &lt;- false<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}()<br>
&nbsp;&nbsp;&nbsp;&nbsp;}<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;for {<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;-c<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;reqC--<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if reqC == 0 {<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;break<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
&nbsp;&nbsp;&nbsp;&nbsp;}<br>
}<br>
<br>
func TestProjectCodeReq(t *testing.T) {<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;setup(true)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;proj := &quot;xxtail&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;f := &quot;main.go.html&quot;<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;resp, err := http.Get(fmt.Sprintf(&quot;<a href="http://localhost:8999/code/%s/%s">http://localhost:8999/code/%s/%s</a>&quot;, proj, f))<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;if resp.StatusCode != 200 || err != nil {<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;t.Fatal(&quot;bad response from /code&quot;)<br>
&nbsp;&nbsp;&nbsp;&nbsp;}<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;resp, err = http.Get(fmt.Sprintf(&quot;<a href="http://localhost:8999/code/BADPROJECT/%s">http://localhost:8999/code/BADPROJECT/%s</a>&quot;, f))<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;if resp.StatusCode != 404 || err != nil {<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;t.Fatal(&quot;expected 404 on bad project in /code&quot;)<br>
&nbsp;&nbsp;&nbsp;&nbsp;}<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;resp, err = http.Get(fmt.Sprintf(&quot;<a href="http://localhost:8999/code/xxtail">http://localhost:8999/code/xxtail</a>&quot;))<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;if resp.StatusCode != 404 || err != nil {<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;t.Fatal(&quot;expected 404 on bad project in /code&quot;)<br>
&nbsp;&nbsp;&nbsp;&nbsp;}<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;resp, err = http.Get(fmt.Sprintf(&quot;<a href="http://localhost:8999/code/%s/%s">http://localhost:8999/code/%s/%s</a>&quot;, proj, f))<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;if resp.StatusCode != 200 || err != nil {<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;t.Fatal(&quot;expected to get file on /code&quot;)<br>
&nbsp;&nbsp;&nbsp;&nbsp;}<br>
}<br>
<br>
func TestMustachedNavAndCCS(t *testing.T) {<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;setup(true)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;ps := Pages{}<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;filepath.Walk(&quot;html&quot;, ps.Walker)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;p := Projects{}<br>
&nbsp;&nbsp;&nbsp;&nbsp;filepath.Walk(&quot;projects&quot;, p.Walker)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;mustacheTest := func(file, pattern, newdata string) {<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;e := ps.Mustache(file, pattern, newdata)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if e != nil || bytes.Index(ps[file], []byte(newdata)) == -1 {<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;t.Logf(&quot;mustache failed for file [%s] pattern [%s]&quot;, file, pattern)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;t.Fail()<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
&nbsp;&nbsp;&nbsp;&nbsp;}<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;mustacheTest(&quot;html/index.html&quot;, &quot;{{{nav}}}&quot;, &quot;&quot;)<br>
&nbsp;&nbsp;&nbsp;&nbsp;mustacheTest(&quot;html/project.html&quot;, &quot;{{{nav}}}&quot;, &quot;&quot;)<br>
&nbsp;&nbsp;&nbsp;&nbsp;mustacheTest(&quot;html/project.html&quot;, &quot;{{{projectnav}}}&quot;, &quot;&quot;)<br>
&nbsp;&nbsp;&nbsp;&nbsp;mustacheTest(&quot;html/contact.html&quot;, &quot;{{{nav}}}&quot;, &quot;&quot;)<br>
&nbsp;&nbsp;&nbsp;&nbsp;mustacheTest(&quot;html/about.html&quot;, &quot;{{{nav}}}&quot;, &quot;&quot;)<br>
&nbsp;&nbsp;&nbsp;&nbsp;mustacheTest(&quot;html/codepage.html&quot;, &quot;{{{projectnav}}}&quot;, &quot;&quot;)<br>
&nbsp;&nbsp;&nbsp;&nbsp;mustacheTest(&quot;html/codepage.html&quot;, &quot;{{{filenav}}}&quot;, &quot;&quot;)<br>
&nbsp;&nbsp;&nbsp;&nbsp;mustacheTest(&quot;html/codepage.html&quot;, &quot;{{{url}}}&quot;, &quot;&quot;)<br>
}<br>
<br>
func TestMustacheFunc(t *testing.T) {<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;setup(true)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;ps := Pages{}<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;filepath.Walk(&quot;html&quot;, ps.Walker)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;err := ps.Mustache(&quot;dfsfadss&quot;, &quot;&quot;, &quot;&quot;)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;if err == nil {<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;t.Fatal(&quot;expected result: err on not finding bogus html file&quot;)<br>
&nbsp;&nbsp;&nbsp;&nbsp;}<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;testPage := &quot;html/project.html&quot;<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;beforeIdx := bytes.Index(ps[testPage], []byte(&quot;{{{projectnav}}}&quot;))<br>
&nbsp;&nbsp;&nbsp;&nbsp;if beforeIdx == -1 {<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;t.Fatal(&quot;no replace str&quot;)<br>
&nbsp;&nbsp;&nbsp;&nbsp;}<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;err = ps.Mustache(testPage, &quot;{{{projectnav}}}&quot;, &quot;fail&quot;)<br>
&nbsp;&nbsp;&nbsp;&nbsp;if err != nil {<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;t.Fatal(&quot;failed replacing in Mustache&quot;)<br>
&nbsp;&nbsp;&nbsp;&nbsp;}<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;beforeIdx = bytes.Index(ps[testPage], []byte(&quot;{{{projectnav}}}&quot;))<br>
&nbsp;&nbsp;&nbsp;&nbsp;if beforeIdx != -1 {<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;t.Fatal(&quot;failed replacing in Mustache&quot;)<br>
&nbsp;&nbsp;&nbsp;&nbsp;}<br>
}<br>
<br>
func TestLoadProjects(t *testing.T) {<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;setup(true)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;p := Projects{}<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;filepath.Walk(&quot;projects&quot;, p.Walker)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;if len(p) == 0 {<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;t.Fatal(&quot;didnt walk shit&quot;)<br>
&nbsp;&nbsp;&nbsp;&nbsp;}<br>
}<br>
<br>
func TestLoadPages(t *testing.T) {<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;setup(true)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;ps := Pages{}<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;filepath.Walk(&quot;html&quot;, ps.Walker)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;expectedPages := strings.Split(content, &quot;\n&quot;)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;if len(ps) != len(expectedPages) {<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;t.Log(content)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;t.Fatal(fmt.Sprintf(&quot;walked %d expected %d&quot;, len(ps), len(expectedPages)))<br>
&nbsp;&nbsp;&nbsp;&nbsp;}<br>
}<br>
<br>
func TestMimeType(t *testing.T) {<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;setup(true)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;url := &quot;<a href="http://localhost:8999/main.css">http://localhost:8999/main.css</a>&quot;<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;req, err := http.Get(url)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;if err != nil {<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;t.Fatal(err)<br>
&nbsp;&nbsp;&nbsp;&nbsp;}<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;if req.Header.Get(&quot;Content-Type&quot;) != &quot;text/css; charset=utf-8&quot; {<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;t.Fatal(&quot;didnt get proper mime type &quot; + req.Header.Get(&quot;Content-Type&quot;))<br>
&nbsp;&nbsp;&nbsp;&nbsp;}<br>
&nbsp;&nbsp;&nbsp;&nbsp;req.Body.Close()<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;url = &quot;<a href="http://localhost:8999/bg.png">http://localhost:8999/bg.png</a>&quot;<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;req, err = http.Get(url)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;if err != nil {<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;t.Fatal(err)<br>
&nbsp;&nbsp;&nbsp;&nbsp;}<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;if req.Header.Get(&quot;Content-Type&quot;) != &quot;image/png&quot; {<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;t.Fatal(&quot;didnt get proper mime type &quot; + req.Header.Get(&quot;Content-Type&quot;))<br>
&nbsp;&nbsp;&nbsp;&nbsp;}<br>
&nbsp;&nbsp;&nbsp;&nbsp;req.Body.Close()<br>
}<br>
<br>
func TestResumeForward(t *testing.T) {<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;setup(true)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;url := &quot;<a href="http://localhost:8999/resume/">http://localhost:8999/resume/</a>&quot;<br>
&nbsp;&nbsp;&nbsp;&nbsp;noredir := &amp;http.Transport{}<br>
&nbsp;&nbsp;&nbsp;&nbsp;req, err := http.NewRequest(&quot;GET&quot;, url, nil)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;if err != nil {<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;t.Fatal(err)<br>
&nbsp;&nbsp;&nbsp;&nbsp;}<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;resp, err := noredir.RoundTrip(req)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;if err != nil {<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;t.Fatal(err)<br>
&nbsp;&nbsp;&nbsp;&nbsp;}<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;if resp.Header.Get(&quot;Location&quot;) == &quot;&quot; || resp.StatusCode != 301 {<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;t.Fatal(&quot;didnt forward /resume request&quot;)<br>
&nbsp;&nbsp;&nbsp;&nbsp;}<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;resp.Body.Close()<br>
}<br>
<br>
var setupOnce sync.Once<br>
<br>
func setup(silenceLog bool) {<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;if silenceLog {<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;nullBuff := NullBuff{}<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;log.SetOutput(&amp;nullBuff)<br>
&nbsp;&nbsp;&nbsp;&nbsp;} else {<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;log.SetOutput(os.Stdout)<br>
&nbsp;&nbsp;&nbsp;&nbsp;}<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;setupOnce.Do(startWebAppAndWait)<br>
}<br>
<br>
// starts the web app and waits a request to complete<br>
func startWebAppAndWait() {<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;go StartHTTP(&quot;localhost:8999&quot;)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;// wait for app to start<br>
&nbsp;&nbsp;&nbsp;&nbsp;for {<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;_, err := http.Get(&quot;<a href="http://localhost:8999/">http://localhost:8999/</a>&quot;)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if err == nil {<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;break<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
&nbsp;&nbsp;&nbsp;&nbsp;}<br>
}<br>
<br>
type NullBuff bytes.Buffer<br>
<br>
func (nb *NullBuff) Write(p []byte) (n int, err error) {<br>
&nbsp;&nbsp;&nbsp;&nbsp;// do nothing<br>
&nbsp;&nbsp;&nbsp;&nbsp;return n, nil<br>
}<br>
</div>
</body>
</html>
<!-- vim: set foldmethod=manual : -->
